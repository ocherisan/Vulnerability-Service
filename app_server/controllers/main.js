var User = require('../models/users');
//var async = require('async');
const validator = require('express-validator');

module.exports.index = function(req, res) {
    res.render('index', {
        title: 'Service',
        header: {
            title: 'Vulnerability Service',
            button1: 'Sign in',
            button2: 'Sign up'
        },
        errors: []
    });
};

module.exports.check_user = [
    validator.body('login', 'Login is required').trim().isLength({min:1}),
    validator.sanitizeBody('login').escape(),
    (req, res, next) => {
        const errors = validator.validationResult(req);

        if (!errors.isEmpty()) {
            res.render('index', {
                title: 'Service',
                header: {
                    title: 'Vulnerability Service',
                    button1: 'Sign in',
                    button2: 'Sign up'
                },
                errors: errors.array()
            });
        }
        else {
            var hash = req.body.password;
            User.findOne({ login: req.body.login, hashPassword: hash})
                .exec(function (err, user) {
                    if (err) { return next(err);}
                    if (user) {
                        //TODO:  кроме перенаправления должна быть создана сессия
                        res.redirect('/search');
                    }
                    else {
                        res.render('index', {
                            title: 'Service',
                            header: {
                                title: 'Vulnerability Service',
                                button1: 'Sign in',
                                button2: 'Sign up'
                            },
                            notFound: true
                        });
                    }
                })
        }
    }
];


